<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
<script>
        const chatRoomList = document.querySelector('#chat-room-list');
        let chatLog = document.querySelector('#chat-log');
        const scrollChatLog = () => {
                chatLog.scrollTop = chatLog.scrollHeight;
        };
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatSendButton = document.querySelector('#send-button');

        const appendMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-bubble', sender + '-message');
            messageDiv.innerText = message;
            chatLog.appendChild(messageDiv);
            scrollChatLog();
        };

        const connectWebSocket = () => {
                const isHTTPS = window.location.protocol === "https:";
                const chatSocket = new WebSocket(
                        (isHTTPS ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/'
                );

                scrollChatLog();

                chatSocket.onmessage = function (e) {
                        const data = JSON.parse(e.data);
                        appendMessage(data.message, data.sender);
                };

                chatSocket.onclose = function (e) {
                        console.error('Chat socket closed unexpectedly. Reconnecting...');
                        setTimeout(() => {
                                connectWebSocket();
                        }, 1000);
                };

                chatMessageInput.focus();
                chatMessageInput.onkeyup = function (e) {
                        if (e.keyCode === 13) {
                                chatSendButton.click();
                        }
                };

                chatSendButton.onclick = function (e) {
                        const message = chatMessageInput.value;
                        if (message.trim() === '') {
                                return;
                        }
                        chatSocket.send(JSON.stringify({
                                'message': message
                        }));
                        chatMessageInput.value = '';
                };
        };
        
        connectWebSocket();
</script>
